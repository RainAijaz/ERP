<div class="flex flex-col h-[calc(100vh-8rem)] gap-4">
  <div class="bg-white p-4 border border-slate-200 rounded-xl shadow-sm flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold text-slate-800"><%= t('approval_settings') %></h1>
      <p class="text-sm text-slate-500"><%= t('approval_rules') %></p>
    </div>
  </div>

  <form action="/administration/approvals/settings" method="POST" class="flex-1 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <div class="flex-1 overflow-auto relative">
      <% const labelForVoucher = (row) => {
        if (row.labelKey && /^[a-z0-9_]+$/.test(row.labelKey)) return t(row.labelKey);
        return row.name || row.code;
      }; %>
      <% const labelForScreen = (row) => {
        if (!row.description) return row.scopeKey || '';
        return /^[a-z0-9_]+$/.test(row.description) ? t(row.description) : row.description;
      }; %>
      <table class="w-full text-left border-collapse">
        <thead class="bg-slate-50 sticky top-0 z-20 shadow-sm">
          <tr>
            <th class="p-4 text-xs font-bold uppercase text-slate-500 border-b border-r sticky left-0 bg-slate-50 min-w-50 z-30">
              <%= t('voucher') %>
            </th>
            <% const actions = [
                 { key: 'create', label: t('create') },
                 { key: 'edit', label: t('edit') },
                 { key: 'delete', label: t('deactivate') || t('delete') },
                 { key: 'hard_delete', label: t('permanent_delete') }
               ]; %>
            <% actions.forEach(act => { %>
              <th class="p-2 border-b text-center min-w-20">
                <span class="text-xs font-bold uppercase text-slate-500"><%= act.label %></span>
              </th>
            <% }) %>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <% voucherRows.forEach(vt => { %>
            <tr class="hover:bg-amber-50/50 transition-colors">
              <td class="px-4 py-3 border-r text-sm font-medium text-slate-700 sticky left-0 bg-white">
                <div class="flex flex-col">
                  <span><%= labelForVoucher(vt) %></span>
                  <span class="text-[10px] text-slate-400 font-mono font-normal"><%= vt.code %></span>
                </div>
              </td>
              <% actions.forEach(act => { %>
                <td class="text-center border-r last:border-r-0">
                  <input type="checkbox" name="VOUCHER_TYPE:<%= vt.code %>:<%= act.key %>" <%= policyMap?.VOUCHER_TYPE?.[vt.code]?.[act.key] ? 'checked' : '' %> class="rounded text-accent focus:ring-accent w-4 h-4">
                </td>
              <% }) %>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <div class="h-px bg-slate-200 my-6"></div>

      <table class="w-full text-left border-collapse">
        <thead class="bg-slate-50 sticky top-0 z-20 shadow-sm">
          <tr>
            <th class="p-4 text-xs font-bold uppercase text-slate-500 border-b border-r sticky left-0 bg-slate-50 min-w-50 z-30">
              <%= t('screen') %>
            </th>
            <% actions.forEach(act => { %>
              <th class="p-2 border-b text-center min-w-20">
                <span class="text-xs font-bold uppercase text-slate-500"><%= act.label %></span>
              </th>
            <% }) %>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <% screenRows.forEach(row => { %>
            <% const isGroupRow = !row.scopeKey; %>
            <tr class="transition-colors approval-screen-row <%= isGroupRow ? 'bg-slate-50/60' : 'hover:bg-amber-50/50' %>" data-path="<%= row.path %>" data-parent="<%= row.parentPath || '' %>" data-depth="<%= row.depth %>" data-has-children="<%= row.hasChildren ? 'true' : 'false' %>">
              <td class="px-4 py-3 border-r text-sm font-medium text-slate-700 sticky left-0 bg-white">
                <div class="flex items-start gap-2 approval-indent" data-depth="<%= row.depth %>">
                  <% if (row.hasChildren) { %>
                    <button type="button" class="inline-flex w-5 h-5 items-center justify-center rounded-full border border-slate-300 text-slate-500 text-[10px] approval-group-toggle" data-toggle="<%= row.path %>">−</button>
                  <% } else { %>
                    <span class="inline-flex w-5 h-5 items-center justify-center text-[10px] text-transparent">•</span>
                  <% } %>
                  <div class="flex flex-col">
                    <% if (isGroupRow) { %>
                      <span class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-2.5 py-1.5 text-[10px] font-semibold uppercase tracking-[0.14em] text-slate-600">
                        <%= labelForScreen(row) %>
                      </span>
                    <% } else { %>
                      <span class="block rounded-lg px-2.5 py-2 text-sm text-slate-700">
                        <%= labelForScreen(row) %>
                      </span>
                    <% } %>
                    <% if (row.scopeKey) { %>
                      <span class="text-[10px] text-slate-400 font-mono font-normal"><%= row.scopeKey %></span>
                    <% } %>
                  </div>
                </div>
              </td>
              <% actions.forEach(act => { %>
                <td class="text-center border-r last:border-r-0">
                  <% if (row.scopeKey) { %>
                    <input type="checkbox" name="SCREEN:<%= row.scopeKey %>:<%= act.key %>" <%= policyMap?.SCREEN?.[row.scopeKey]?.[act.key] ? 'checked' : '' %> class="rounded text-accent focus:ring-accent w-4 h-4">
                  <% } else { %>
                    <span class="text-xs text-slate-300">—</span>
                  <% } %>
                </td>
              <% }) %>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center sticky bottom-0 z-30">
      <div class="text-xs text-slate-500"><%= t('requires_approval') %></div>
      <button type="submit" class="bg-accent text-white px-8 py-2.5 rounded-lg text-sm font-bold shadow-sm hover:bg-accent/90 transition-transform active:scale-95">
        <%= t('save_changes') %>
      </button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const rows = Array.from(document.querySelectorAll('.approval-screen-row'));
    const collapsedPaths = new Set();

    const setCollapsed = (path, collapsed, remember = true) => {
      rows.forEach(row => {
        if (row.getAttribute('data-path').startsWith(`${path}.`)) {
          row.classList.toggle('hidden', collapsed);
        }
      });
      const toggle = document.querySelector(`.approval-group-toggle[data-toggle='${path}']`);
      if (toggle) toggle.textContent = collapsed ? '+' : '−';
      if (remember) {
        if (collapsed) collapsedPaths.add(path);
        else collapsedPaths.delete(path);
      }
    };

    rows.forEach(row => {
      const depth = Number(row.getAttribute('data-depth') || 0);
      const indent = row.querySelector('.approval-indent');
      if (indent) indent.style.paddingLeft = `${depth * 16}px`;

      if (row.getAttribute('data-has-children') === 'true') {
        const path = row.getAttribute('data-path');
        const depth = Number(row.getAttribute('data-depth') || 0);
        const defaultCollapsed = depth >= 1;
        setCollapsed(path, defaultCollapsed, true);
        const btn = row.querySelector(`.approval-group-toggle[data-toggle='${path}']`);
        if (btn) btn.addEventListener('click', () => {
          const isCollapsed = collapsedPaths.has(path);
          setCollapsed(path, !isCollapsed, true);
        });
      }
    });
  });
</script>
