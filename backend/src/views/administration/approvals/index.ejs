<%
  const escapeAttr = (value) =>
    String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  const jsonAttr = (value) => escapeAttr(JSON.stringify(value ?? null));
  const getAction = (row) => {
    if (row?.new_value?._action) return row.new_value._action;
    if (row?.new_value && row?.entity_id === "NEW") return "create";
    if (!row?.new_value && row?.old_value) return "delete";
    return "update";
  };
%>
<div class="mx-auto w-full max-w-7xl space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-display text-slate-800"><%= t("approvals") %></h1>
    
    <div class="flex gap-2">
      <% ["PENDING", "APPROVED", "REJECTED"].forEach(s => { %>
        <a href="?status=<%= s %>" 
           class="rounded-full px-4 py-1 text-xs font-bold transition <%= currentStatus === s ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 border border-slate-200' %>">
           <%= t(s.toLowerCase()) %>
        </a>
      <% }) %>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
    <table class="w-full text-sm text-left">
      <thead class="bg-slate-50 text-xs font-semibold uppercase text-slate-500">
        <tr>
          <th class="px-6 py-3"><%= t("date") %></th>
          <th class="px-6 py-3"><%= t("requester") %></th>
          <th class="px-6 py-3"><%= t("summary") %></th>
          <th class="px-6 py-3"><%= t("details") || "Details" %></th>
          <th class="px-6 py-3"><%= t("status") %></th>
          <th class="px-6 py-3 text-right"><%= t("actions") %></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        <% if (rows.length === 0) { %>
           <tr><td colspan="6" class="p-6 text-center text-slate-400"><%= t("no_entries") %></td></tr>
        <% } %>
        
        <% rows.forEach(row => { %>
          <% const actionType = getAction(row); %>
          <tr class="hover:bg-slate-50">
            <td class="px-6 py-4 text-slate-600">
              <%= new Date(row.requested_at).toLocaleDateString() %>
            </td>
            <td class="px-6 py-4 font-medium text-slate-900">
              <%= row.requester_name %>
            </td>
            <td class="px-6 py-4 text-slate-600">
              <%= row.summary %>
            </td>
            <td class="px-6 py-4">
              <button
                type="button"
                class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-bold uppercase tracking-[0.14em] text-slate-600 transition hover:border-slate-300 hover:text-slate-800"
                data-approval-view
                data-approval-id="<%= row.id %>"
                data-action="<%= actionType %>"
                data-status="<%= row.status %>"
                data-old="<%= jsonAttr(row.old_value) %>"
                data-new="<%= jsonAttr(row.new_value) %>"
              >
                <%= t("view") || "View" %>
              </button>
            </td>
            <td class="px-6 py-4">
               <%- include("../../base/partials/approval-badge", { status: row.status }) %>
            </td>
            <td class="px-6 py-4 text-right">
              <% if (row.status === 'PENDING') { %>
                <div class="flex justify-end gap-2">
                  <form action="<%= basePath %>/<%= row.id %>/approve" method="POST" class="inline">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="rounded-lg bg-emerald-50 px-3 py-1.5 text-xs font-bold text-emerald-700 hover:bg-emerald-100 transition">
                      <%= t("approve") || "Approve" %>
                    </button>
                  </form>
                  <form action="<%= basePath %>/<%= row.id %>/reject" method="POST" class="inline">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="rounded-lg bg-rose-50 px-3 py-1.5 text-xs font-bold text-rose-700 hover:bg-rose-100 transition">
                      <%= t("reject") || "Reject" %>
                    </button>
                  </form>
                </div>
              <% } else { %>
                 <span class="text-xs text-slate-400">
                   <%= row.decided_at ? new Date(row.decided_at).toLocaleDateString() : '' %>
                 </span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<div class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 p-4" data-approval-detail-modal>
  <div class="w-full max-w-6xl max-h-[85vh] rounded-2xl border border-slate-200 bg-white shadow-xl flex flex-col overflow-hidden" data-approval-detail-panel>
    <div class="flex items-start justify-between border-b border-slate-200 px-6 py-4">
      <div>
        <div class="text-sm font-semibold text-slate-700"><%= t("details") || "Details" %></div>
        <p class="mt-1 text-xs text-slate-500" data-approval-detail-subtitle></p>
      </div>
      <div class="flex items-center gap-2">
        <% if (user && user.isAdmin) { %>
          <button type="button" class="hidden rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.14em] text-slate-600 transition hover:border-slate-300 hover:text-slate-800" data-approval-edit-btn>
            <%= t("edit") || "Edit" %>
          </button>
          <button type="button" class="hidden rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.14em] text-slate-600 transition hover:border-slate-300 hover:text-slate-800" data-approval-edit-cancel>
            <%= t("cancel") || "Cancel" %>
          </button>
          <button type="button" class="hidden rounded-lg bg-accent px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.14em] text-white transition hover:opacity-90" data-approval-edit-save>
            <%= t("save_changes") || "Save Changes" %>
          </button>
        <% } %>
        <button type="button" class="text-slate-400 hover:text-slate-600" data-approval-detail-close>
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
    </div>
    <div class="grid gap-4 px-6 py-5 md:grid-cols-2 overflow-y-auto">
      <div data-approval-detail-before>
        <div class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500 mb-3"><%= t("before") || "Before" %></div>
        <div class="space-y-4" data-approval-preview-before></div>
      </div>
      <div data-approval-detail-after>
        <div class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500 mb-3"><%= t("after") || "After" %></div>
        <div class="space-y-4" data-approval-preview-after></div>
      </div>
      <div class="md:col-span-2" data-approval-detail-single>
        <div class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500 mb-3"><%= t("details") || "Details" %></div>
        <div class="space-y-4" data-approval-preview-single></div>
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    const modal = document.querySelector("[data-approval-detail-modal]");
    const closeBtn = document.querySelector("[data-approval-detail-close]");
    const editBtn = document.querySelector("[data-approval-edit-btn]");
    const editCancelBtn = document.querySelector("[data-approval-edit-cancel]");
    const editSaveBtn = document.querySelector("[data-approval-edit-save]");
    const beforeWrap = document.querySelector("[data-approval-detail-before]");
    const afterWrap = document.querySelector("[data-approval-detail-after]");
    const singleWrap = document.querySelector("[data-approval-detail-single]");
    const modalPanel = document.querySelector("[data-approval-detail-panel]");
    const beforeBox = document.querySelector("[data-approval-preview-before]");
    const afterBox = document.querySelector("[data-approval-preview-after]");
    const singleBox = document.querySelector("[data-approval-preview-single]");
    const subtitle = document.querySelector("[data-approval-detail-subtitle]");
    const previewBase = "<%= basePath %>";
    const csrfToken = "<%= csrfToken %>";
    const isAdmin = <%= user && user.isAdmin ? "true" : "false" %>;
    const labels = {
      approvalNoChanges: "<%= t('approval_no_changes') || 'No changes found.' %>",
      approvalEditFailed: "<%= t('approval_edit_failed') || 'Unable to update approval request.' %>",
      approvalEditSaved: "<%= t('approval_request_updated') || 'Approval request updated.' %>",
      saveChanges: "<%= t('save_changes') || 'Save Changes' %>",
      saving: "<%= t('saving') || 'Saving...' %>",
    };
    const debugPreview = true;
    let currentModalState = null;
    let editMode = false;
    let bodyScrollLocked = false;

    const setBodyScrollLock = (locked) => {
      const body = document.body;
      if (!body) return;
      if (locked && !bodyScrollLocked) {
        body.classList.add("overflow-hidden");
        bodyScrollLocked = true;
        return;
      }
      if (!locked && bodyScrollLocked) {
        body.classList.remove("overflow-hidden");
        bodyScrollLocked = false;
      }
    };

    const decodeHtml = (raw) => {
      if (!raw) return "";
      const textarea = document.createElement("textarea");
      textarea.innerHTML = raw;
      return textarea.value;
    };

    const safeParse = (raw) => {
      if (!raw) return null;
      try {
        return JSON.parse(decodeHtml(raw));
      } catch (err) {
        return decodeHtml(raw);
      }
    };

    const formatKey = (key) =>
      String(key || "")
        .replace(/_/g, " ")
        .replace(/(^|\\s)\\S/g, (m) => m.toUpperCase());

    const formatValue = (value) => {
      if (value === null || typeof value === "undefined") return "-";
      if (typeof value === "object") {
        try {
          return JSON.stringify(value, null, 2);
        } catch (err) {
          return String(value);
        }
      }
      return String(value);
    };

    const initMultiSelects = (panel) => {
      if (!panel) return;
      const wraps = panel.querySelectorAll("[data-multi-select]");
      wraps.forEach((wrap) => {
        if (wrap.dataset.multiReady === "true") return;
        wrap.dataset.multiReady = "true";

        const select = wrap.querySelector("select[multiple]");
        const trigger = wrap.querySelector("[data-multi-trigger]");
        const menu = wrap.querySelector("[data-multi-menu]");
        const placeholder = wrap.querySelector("[data-multi-placeholder]");
        const tags = wrap.querySelector("[data-multi-tags]");
        if (!select || !trigger || !menu || !placeholder) return;

        const optionsWrap = document.createElement("div");
        optionsWrap.className = "space-y-1";
        menu.innerHTML = "";
        menu.appendChild(optionsWrap);

        const updateVisuals = () => {
          const selected = Array.from(select.selectedOptions).map((opt) => (opt.textContent || "").trim()).filter(Boolean);
          placeholder.textContent = selected.length ? `${selected.length} selected` : "<%= t('select') %>";
          if (tags) {
            tags.innerHTML = "";
            selected.forEach((labelText) => {
              const tag = document.createElement("span");
              tag.className = "inline-flex items-center rounded-full border border-slate-200 bg-white px-2.5 py-1 text-[10px] font-semibold uppercase tracking-[0.12em] text-slate-600";
              tag.textContent = labelText;
              tags.appendChild(tag);
            });
          }
        };

        const closeMenu = () => menu.classList.add("hidden");
        const renderMenu = () => {
          optionsWrap.innerHTML = "";
          Array.from(select.options).forEach((opt) => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-sm text-slate-700 transition hover:bg-amber-50/60";
            const label = document.createElement("span");
            label.textContent = (opt.textContent || "").trim();
            const check = document.createElement("span");
            check.className = "text-xs text-slate-400";
            check.textContent = opt.selected ? "*" : "";
            button.appendChild(label);
            button.appendChild(check);
            button.addEventListener("click", (event) => {
              event.preventDefault();
              event.stopPropagation();
              opt.selected = !opt.selected;
              select.dispatchEvent(new Event("change", { bubbles: true }));
              renderMenu();
            });
            optionsWrap.appendChild(button);
          });
          updateVisuals();
        };

        trigger.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          menu.classList.toggle("hidden");
        });

        document.addEventListener("click", (event) => {
          if (!wrap.contains(event.target)) closeMenu();
        });

        select.addEventListener("change", renderMenu);
        renderMenu();
      });
    };

    const buildFields = (value) => {
      if (!value || typeof value !== "object") return [];
      const skip = new Set(["_action", "_summary", "created_at", "created_by", "updated_at", "updated_by"]);
      return Object.keys(value)
        .filter((key) => !skip.has(key))
        .map((key) => ({ key, label: formatKey(key), value: formatValue(value[key]) }));
    };

    const renderFields = (container, fields) => {
      if (!container) return;
      container.innerHTML = "";
      if (!fields.length) {
        const empty = document.createElement("div");
        empty.className = "text-xs text-slate-400";
        empty.textContent = "<%= t('no_entries') || 'No entries yet.' %>";
        container.appendChild(empty);
        return;
      }
      fields.forEach((field) => {
        const row = document.createElement("div");
        row.className = "rounded-xl border border-slate-200 bg-white p-3";
        const label = document.createElement("div");
        label.className = "text-[10px] font-semibold uppercase tracking-[0.14em] text-slate-500";
        label.textContent = field.label;
        const value = document.createElement("pre");
        value.className = "mt-1 whitespace-pre-wrap text-xs text-slate-700";
        value.textContent = field.value;
        row.appendChild(label);
        row.appendChild(value);
        container.appendChild(row);
      });
    };

    const normalizeArray = (value) => {
      if (!value) return [];
      if (Array.isArray(value)) return value.map(String);
      if (typeof value === "object") return Object.values(value).map(String);
      return String(value)
        .split(",")
        .map((entry) => entry.trim())
        .filter(Boolean);
    };

    const applyValuesToFields = (panel, values) => {
      if (!panel) return;
      initMultiSelects(panel);
      const payload = values || {};
      if (debugPreview) {
        console.log("[APPROVAL PREVIEW DEBUG] applyValues", {
          previewType: panel.getAttribute("data-preview-type"),
          previewAction: panel.getAttribute("data-preview-action"),
          payloadType: typeof payload,
          payloadKeys: payload && typeof payload === "object" ? Object.keys(payload) : null,
        });
      }
      panel.querySelectorAll("[data-field]").forEach((input) => {
        const name = input.getAttribute("data-field");
        if (!name) return;
        const value = Object.prototype.hasOwnProperty.call(payload, name) ? payload[name] : "";

        if (input.type === "checkbox") {
          if (input.dataset.multi === "true") {
            const selected = normalizeArray(value);
            input.checked = selected.includes(String(input.value));
          } else {
            input.checked = value === true || value === "true" || value === "1" || value === "on";
          }
          return;
        }

        if (input.tagName === "SELECT" && input.multiple) {
          const selected = normalizeArray(value);
          Array.from(input.options).forEach((option) => {
            option.selected = selected.includes(String(option.value));
          });
          return;
        }

        if (Array.isArray(value)) {
          input.value = value[0] ?? "";
        } else {
          input.value = value ?? "";
        }
      });

      panel.querySelectorAll("[data-hide-on-create]").forEach((node) => {
        if (payload && payload._previewAction === "create") {
          node.classList.add("hidden");
        } else {
          node.classList.remove("hidden");
        }
      });

      panel.querySelectorAll("[data-multi-select]").forEach((wrap) => {
        const select = wrap.querySelector("select[multiple]");
        const tags = wrap.querySelector("[data-multi-tags]");
        const placeholder = wrap.querySelector("[data-multi-placeholder]");
        if (!select || !tags) return;
        tags.innerHTML = "";
        const selectedLabels = Array.from(select.selectedOptions).map((opt) => opt.textContent.trim()).filter(Boolean);
        if (placeholder) {
          placeholder.textContent = selectedLabels.length ? `${selectedLabels.length} selected` : "<%= t('select') %>";
        }
        selectedLabels.forEach((label) => {
          const tag = document.createElement("span");
          tag.className = "inline-flex items-center rounded-full border border-slate-200 bg-white px-2.5 py-1 text-[10px] font-semibold uppercase tracking-[0.12em] text-slate-600";
          tag.textContent = label;
          tags.appendChild(tag);
        });
      });
    };

    const disableInputs = (panel) => {
      if (!panel) return;
      panel.querySelectorAll("input, select, textarea, button").forEach((el) => {
        if (el.hasAttribute("data-approval-view")) return;
        if (el.tagName === "BUTTON") {
          el.disabled = true;
          el.classList.add("pointer-events-none");
          return;
        }
        el.disabled = true;
        el.readOnly = true;
        el.classList.add("cursor-not-allowed");
      });
    };

    const enableInputs = (panel) => {
      if (!panel) return;
      panel.querySelectorAll("input, select, textarea").forEach((el) => {
        if (!el.hasAttribute("data-field")) return;
        el.disabled = false;
        el.readOnly = false;
        el.classList.remove("cursor-not-allowed");
      });
      panel.querySelectorAll("[data-multi-select] button").forEach((button) => {
        button.disabled = false;
        button.classList.remove("pointer-events-none");
      });
    };

    const getEditPanel = () => {
      if (!currentModalState) return null;
      if (currentModalState.action === "update") {
        return afterBox.querySelector("[data-approval-preview]");
      }
      if (currentModalState.action === "create") {
        return singleBox.querySelector("[data-approval-preview]");
      }
      return null;
    };

    const setEditButtons = () => {
      const eligible = Boolean(
        isAdmin &&
          currentModalState &&
          currentModalState.status === "PENDING" &&
          (currentModalState.action === "update" || currentModalState.action === "create") &&
          getEditPanel() &&
          getEditPanel().querySelectorAll("[data-field]").length > 0,
      );
      if (editBtn) editBtn.classList.toggle("hidden", !eligible || editMode);
      if (editCancelBtn) editCancelBtn.classList.toggle("hidden", !eligible || !editMode);
      if (editSaveBtn) editSaveBtn.classList.toggle("hidden", !eligible || !editMode);
    };

    const setEditMode = (nextMode) => {
      editMode = Boolean(nextMode);
      const panel = getEditPanel();
      if (panel) {
        if (editMode) {
          initMultiSelects(panel);
          enableInputs(panel);
        } else {
          disableInputs(panel);
          panel.querySelectorAll("[data-multi-menu]").forEach((menu) => menu.classList.add("hidden"));
        }
      }
      setEditButtons();
    };

    const collectEditedValues = (panel) => {
      const values = {};
      const multiCheckboxMap = new Map();
      panel.querySelectorAll("[data-field]").forEach((input) => {
        const name = input.getAttribute("data-field");
        if (!name) return;

        if (input.type === "checkbox") {
          if (input.dataset.multi === "true") {
            if (!multiCheckboxMap.has(name)) multiCheckboxMap.set(name, []);
            if (input.checked) multiCheckboxMap.get(name).push(input.value);
            return;
          }
          values[name] = Boolean(input.checked);
          return;
        }

        if (input.tagName === "SELECT" && input.multiple) {
          values[name] = Array.from(input.selectedOptions).map((option) => option.value);
          return;
        }

        if (input.type === "number") {
          const numeric = String(input.value || "").trim();
          if (numeric === "") {
            values[name] = null;
            return;
          }
          const cast = Number(numeric);
          values[name] = Number.isNaN(cast) ? numeric : cast;
          return;
        }

        values[name] = input.value;
      });
      multiCheckboxMap.forEach((items, key) => {
        values[key] = items;
      });
      return values;
    };

    const saveEdit = async () => {
      if (!currentModalState || !currentModalState.id) return;
      const panel = getEditPanel();
      if (!panel) return;
      const payload = collectEditedValues(panel);
      if (!payload || Object.keys(payload).length === 0) {
        window.alert(labels.approvalNoChanges);
        return;
      }

      if (editSaveBtn) {
        editSaveBtn.disabled = true;
        editSaveBtn.textContent = labels.saving;
      }

      try {
        const body = new URLSearchParams();
        body.set("_csrf", csrfToken);
        body.set("edited_payload", JSON.stringify(payload));

        const response = await fetch(`${previewBase}/${currentModalState.id}/edit`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            Accept: "application/json",
          },
          body: body.toString(),
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok || !data.ok) {
          window.alert((data && data.message) || labels.approvalEditFailed);
          return;
        }
        window.alert(data.message || labels.approvalEditSaved);
        window.location.reload();
      } catch (err) {
        console.error("[APPROVAL EDIT ERROR]", err);
        window.alert(labels.approvalEditFailed);
      } finally {
        if (editSaveBtn) {
          editSaveBtn.disabled = false;
          editSaveBtn.textContent = labels.saveChanges;
        }
      }
    };

    const applyRawMaterialRates = (panel, values) => {
      const rateList = panel.querySelector("[data-rate-list]");
      const template = panel.querySelector("[data-rate-template]");
      if (!rateList || !template) return;

      const rates = Array.isArray(values?.rates) ? values.rates : [];
      rateList.innerHTML = "";
      if (!rates.length) {
        const row = template.content.cloneNode(true);
        rateList.appendChild(row);
      } else {
        rates.forEach((rate) => {
          const row = template.content.cloneNode(true);
          const colorSelect = row.querySelector("[data-rate-color]");
          const sizeSelect = row.querySelector("[data-rate-size]");
          const input = row.querySelector("[data-rate-value]");
          if (colorSelect) colorSelect.value = rate.color_id ?? "";
          if (sizeSelect) sizeSelect.value = rate.size_id ?? "";
          if (input) input.value = rate.purchase_rate ?? "";
          rateList.appendChild(row);
        });
      }

      const addRow = panel.querySelector("[data-rate-add-row]");
      if (addRow) addRow.classList.add("hidden");
      const modeSelect = panel.querySelector("[data-rate-mode]");
      if (modeSelect) modeSelect.disabled = true;
    };

    const applySkuPreview = (panel, values) => {
      const createContainer = panel.querySelector("#create-mode-container");
      const editContainer = panel.querySelector("#edit-rates-container");
      if (editContainer) editContainer.classList.add("hidden");
      if (createContainer) createContainer.classList.remove("hidden");

      const rateList = panel.querySelector("[data-sku-rate-list]");
      const emptyMsg = panel.querySelector("[data-rate-list-empty]");
      if (!rateList) return;

      rateList.innerHTML = "";
      if (emptyMsg) emptyMsg.style.display = "none";

      const setSelect = (name, value) => {
        const select = panel.querySelector(`select[name="${name}"]`);
        if (!select) return;
        const selected = normalizeArray(value);
        if (select.multiple) {
          Array.from(select.options).forEach((option) => {
            option.selected = selected.includes(String(option.value));
          });
        } else {
          select.value = selected[0] || value || "";
        }
      };

      setSelect("item_id", values?.item_id);
      setSelect("size_ids", values?.size_ids || values?.size_id);
      setSelect("grade_ids", values?.grade_ids || values?.grade_id);
      setSelect("color_ids", values?.color_ids || values?.color_id);
      setSelect("packing_type_ids", values?.packing_type_ids || values?.packing_type_id);

      const pickLabel = (name) => {
        const select = panel.querySelector(`select[name="${name}"]`);
        if (!select) return [];
        return Array.from(select.selectedOptions).map((opt) => opt.textContent.trim()).filter(Boolean);
      };

      const sizeLabels = pickLabel("size_ids");
      const gradeLabels = pickLabel("grade_ids");
      const colorLabels = pickLabel("color_ids");
      const packingLabels = pickLabel("packing_type_ids");

      const sizeLabel = sizeLabels[0] || "";
      const gradeLabel = gradeLabels[0] || "";
      const colorLabel = colorLabels[0] || "";
      const packingLabel = packingLabels[0] || "";

      const labelParts = [sizeLabel, packingLabel, gradeLabel, colorLabel].filter(Boolean);
      const label = labelParts.join(", ") || "<%= t('details') || 'Details' %>";

      const row = document.createElement("div");
      row.className = "group flex flex-col gap-2 rounded-xl border border-slate-200 bg-white px-3 py-3 sm:flex-row sm:items-center shadow-sm";
      row.innerHTML = `
        <div class="flex-1 text-xs font-semibold text-slate-600">${label}</div>
        <div class="flex w-full items-center gap-2 sm:w-auto">
          <input class="w-full sm:w-32 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700" type="number" value="${values?.sale_rate ?? ""}" readonly />
        </div>`;
      rateList.appendChild(row);
    };

    const hydratePreviewPanel = (panel) => {
      if (!panel) return;
      const raw = panel.getAttribute("data-preview-values");
      const previewType = panel.getAttribute("data-preview-type");
      const previewAction = panel.getAttribute("data-preview-action") || "update";
      if (debugPreview) {
        console.log("[APPROVAL PREVIEW DEBUG] raw", {
          previewType,
          previewAction,
          rawType: typeof raw,
          rawSnippet: typeof raw === "string" ? raw.slice(0, 200) : raw,
        });
      }
      let values = {};
      try {
        values = raw ? JSON.parse(raw) : {};
      } catch (err) {
        values = {};
      }
      // Some queued payloads are stored as a JSON string inside JSON; parse one more time.
      if (typeof values === "string") {
        try {
          values = JSON.parse(values);
        } catch (err) {
          values = {};
        }
      }
      if (!values || typeof values !== "object") {
        values = {};
      }
      if (debugPreview) {
        console.log("[APPROVAL PREVIEW DEBUG] parsed", {
          previewType,
          valuesType: typeof values,
          keys: values && typeof values === "object" ? Object.keys(values) : null,
        });
      }
      values._previewAction = previewAction;
      applyValuesToFields(panel, values);
      if (previewType === "raw-materials") {
        applyRawMaterialRates(panel, values);
      }
      if (previewType === "skus") {
        applySkuPreview(panel, values);
      }
      const fieldCount = panel.querySelectorAll("[data-field]").length;
      const fallbackBox = panel.querySelector("[data-preview-fallback]");
      if (fallbackBox) {
        if (fieldCount === 0) {
          fallbackBox.classList.remove("hidden");
          const displayValues = values && typeof values === "object" ? values : {};
          renderFields(fallbackBox, buildFields(displayValues));
        } else {
          fallbackBox.classList.add("hidden");
          fallbackBox.innerHTML = "";
        }
      }
      disableInputs(panel);
    };

    const forceHydrateWith = (container, values, action) => {
      if (!container) return;
      container.querySelectorAll("[data-approval-preview]").forEach((panel) => {
        const previewType = panel.getAttribute("data-preview-type");
        const payload = values && typeof values === "object" ? { ...values } : {};
        payload._previewAction = action || panel.getAttribute("data-preview-action") || "update";
        applyValuesToFields(panel, payload);
        if (previewType === "raw-materials") {
          applyRawMaterialRates(panel, payload);
        }
        if (previewType === "skus") {
          applySkuPreview(panel, payload);
        }
        disableInputs(panel);
      });
    };

    const injectFallback = (container, values) => {
      const fields = buildFields(values);
      renderFields(container, fields);
    };

    const loadPreview = async (id, side, container) => {
      if (!container) return false;
      container.innerHTML = "";
      try {
        const res = await fetch(`${previewBase}/${id}/preview?side=${side}`);
        if (!res.ok) return false;
        const html = await res.text();
        if (!html) return false;
        container.innerHTML = html;
        container.querySelectorAll("[data-approval-preview]").forEach((panel) => {
          hydratePreviewPanel(panel);
        });
        return true;
      } catch (err) {
        return false;
      }
    };

    const setModalSize = (previewType) => {
      if (!modalPanel) return;
      if (previewType === "skus") {
        modalPanel.classList.remove("max-w-6xl");
        modalPanel.classList.add("max-w-3xl");
      } else {
        modalPanel.classList.remove("max-w-3xl");
        modalPanel.classList.add("max-w-6xl");
      }
    };

    const open = async (payload) => {
      if (!modal) return;
      const { action, oldValue, newValue, id, status } = payload;
      currentModalState = { action, oldValue, newValue, id, status };
      editMode = false;
      const isUpdate = action === "update";
      beforeWrap.classList.toggle("hidden", !isUpdate);
      afterWrap.classList.toggle("hidden", !isUpdate);
      singleWrap.classList.toggle("hidden", isUpdate);

      subtitle.textContent = action === "delete"
        ? "<%= t('delete') || 'Delete' %>"
        : action === "create"
          ? "<%= t('create') || 'Create' %>"
          : "<%= t('edit') || 'Edit' %>";

      const fillFallback = () => {
        if (isUpdate) {
          injectFallback(beforeBox, oldValue);
          injectFallback(afterBox, newValue);
        } else {
          const single = action === "delete" ? oldValue : newValue;
          injectFallback(singleBox, single);
        }
      };

      if (id) {
        if (isUpdate) {
          const beforeOk = await loadPreview(id, "old", beforeBox);
          if (!beforeOk) {
            injectFallback(beforeBox, oldValue);
          } else {
            forceHydrateWith(beforeBox, oldValue, "update");
          }
          const afterOk = await loadPreview(id, "new", afterBox);
          if (!afterOk) {
            injectFallback(afterBox, newValue);
          } else {
            forceHydrateWith(afterBox, newValue, "update");
          }
          const panel = afterBox.querySelector("[data-approval-preview]") || beforeBox.querySelector("[data-approval-preview]");
          const previewType = panel?.getAttribute("data-preview-type") || "";
          setModalSize(previewType);
        } else {
          const side = action === "delete" ? "old" : "new";
          const singleOk = await loadPreview(id, side, singleBox);
          if (!singleOk) {
            const single = action === "delete" ? oldValue : newValue;
            injectFallback(singleBox, single);
          } else {
            const single = action === "delete" ? oldValue : newValue;
            forceHydrateWith(singleBox, single, action);
          }
          const panel = singleBox.querySelector("[data-approval-preview]");
          const previewType = panel?.getAttribute("data-preview-type") || "";
          setModalSize(previewType);
        }
      } else {
        fillFallback();
        setModalSize("");
      }

      modal.classList.remove("hidden");
      modal.classList.add("flex");
      setBodyScrollLock(true);
      setEditButtons();
    };

    const close = () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      setBodyScrollLock(false);
      editMode = false;
      currentModalState = null;
      setEditButtons();
    };

    closeBtn?.addEventListener("click", close);
    editBtn?.addEventListener("click", () => setEditMode(true));
    editCancelBtn?.addEventListener("click", () => setEditMode(false));
    editSaveBtn?.addEventListener("click", saveEdit);
    modal?.addEventListener("click", (event) => {
      if (event.target === modal) close();
    });

    document.addEventListener("click", (event) => {
      const btn = event.target.closest("[data-approval-view]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const status = btn.getAttribute("data-status");
      const oldValue = safeParse(btn.getAttribute("data-old"));
      const newValue = safeParse(btn.getAttribute("data-new"));
      const id = btn.getAttribute("data-approval-id");
      open({ action, oldValue, newValue, id, status });
    });
  })();
</script>
