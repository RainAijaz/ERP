<div class="flex flex-col gap-6">
  <div class="flex flex-wrap items-center justify-between gap-4 rounded-2xl border border-slate-200 bg-white/90 px-6 py-5 shadow-sm">
    <div class="space-y-1">
      <h1 class="text-2xl font-bold text-slate-800"><%= t('users') %></h1>
      <p class="text-sm text-slate-500"><%= t('manage_system_access') %></p>
    </div>
    <% if (can('SCREEN', 'administration.users', 'create')) { %>
      <button onclick="openModal('/administration/users/form')" class="inline-flex items-center gap-2 rounded-xl bg-accent px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-accent/90 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent/40">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        <%= t('add_user') %>
      </button>
    <% } %>
  </div>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-left text-sm">
        <thead class="bg-slate-50 border-b border-slate-100">
          <tr>
            <th class="px-6 py-4 font-semibold text-slate-600"><%= t('username') %></th>
            <th class="px-6 py-4 font-semibold text-slate-600"><%= t('role') %></th>
            <th class="px-6 py-4 font-semibold text-slate-600"><%= t('assigned_branches') %></th>
            <th class="px-6 py-4 font-semibold text-slate-600"><%= t('email') %></th>
            <th class="px-6 py-4 font-semibold text-slate-600 text-center"><%= t('status') %></th>
            <th class="px-6 py-4 font-semibold text-slate-600 text-right"><%= t('actions') %></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <% if (users.length === 0) { %>
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-slate-400">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-slate-100">
                  <svg class="h-6 w-6 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M16 11c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3 1.3 3 3 3z"></path>
                    <path d="M8 13c1.7 0 3-1.3 3-3S9.7 7 8 7s-3 1.3-3 3 1.3 3 3 3z"></path>
                    <path d="M2 20c0-2.8 2.2-5 5-5"></path>
                    <path d="M22 20c0-2.8-2.2-5-5-5"></path>
                  </svg>
                </div>
                <p class="mt-3 text-sm font-medium text-slate-500"><%= t('no_records_found') %></p>
              </td>
            </tr>
          <% } %>
          <% const canDeactivate = can('SCREEN', 'administration.users', 'delete'); %>
          <% const canHardDelete = can('SCREEN', 'administration.users', 'hard_delete'); %>
          <% users.forEach(u => { %>
            <tr class="hover:bg-slate-50/50 transition-colors">
              <td class="px-6 py-4 font-medium text-slate-900"><%= u.username %></td>
              <td class="px-6 py-4 text-slate-600">
                <span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-1 text-xs font-medium text-amber-700 ring-1 ring-inset ring-amber-200">
                  <%= u.role_name %>
                </span>
              </td>
              <td class="px-6 py-4 text-slate-600"><%= u.branch_names || '-' %></td>
              <td class="px-6 py-4 text-slate-600"><%= u.email || '-' %></td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium <%= u.status === 'Active' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700' %>">
                  <%= t(u.status.toLowerCase()) %>
                </span>
              </td>
              <td class="px-6 py-4 text-right">
                <% if (can('SCREEN', 'administration.users', 'edit')) { %>
                  <button onclick="openModal('/administration/users/form/<%= u.id %>')" class="inline-flex items-center justify-center rounded-md border border-slate-200 bg-white p-2 text-slate-600 transition hover:border-slate-300 hover:text-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent/30">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    <span class="sr-only"><%= t('edit') %></span>
                  </button>
                <% } %>
                <% if (canDeactivate) { %>
                  <button
                    type="button"
                    class="inline-flex items-center justify-center rounded-md border border-slate-200 bg-white p-2 text-slate-600 transition hover:border-slate-300 hover:text-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-200"
                    data-toggle
                    data-toggle-action="/administration/users/<%= u.id %>/toggle"
                    data-toggle-label="<%= u.status === 'Active' ? t('deactivate') : t('activate') %>"
                    title="<%= u.status === 'Active' ? t('deactivate') : t('activate') %>"
                  >
                    <% if (u.status === 'Active') { %>
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 12h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" /></svg>
                    <% } else { %>
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" /><path d="M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" /></svg>
                    <% } %>
                  </button>
                <% } %>
                <% if (canHardDelete) { %>
                  <button
                    type="button"
                    class="inline-flex items-center justify-center rounded-md border border-rose-200 bg-rose-50 p-2 text-rose-600 transition hover:border-rose-300 hover:text-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-200"
                    data-delete
                    data-delete-action="/administration/users/<%= u.id %>/delete"
                    data-delete-label="<%= t('permanent_delete') %>"
                    title="<%= t('permanent_delete') %>"
                  >
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M4 7h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                      <path d="M9 7V5h6v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                      <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                      <path d="M6 7l1 13h10l1-13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                    </svg>
                  </button>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%- include('../../base/partials/modal-shell') %>
<%- include('../../base/partials/confirm-modal', { t, csrfToken }) %>

<style>
  .multi-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid #e2e8f0;
    border-radius: 9999px;
    padding: 4px 10px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #475569;
    background: #fff;
  }

  .multi-tag button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 9999px;
    border: 1px solid #e2e8f0;
    color: #64748b;
    transition: color 0.2s ease, border-color 0.2s ease;
  }

  .multi-tag button:hover {
    color: #0f172a;
    border-color: #cbd5f5;
  }

  [data-multi-select] [data-multi-menu] {
    width: 100%;
    max-width: 100%;
  }
</style>

<script>
  const csrfToken = "<%= csrfToken %>";
  // Unified Modal Script
  const i18nSelect = "<%= t('select') %>";
  const i18nSelected = "<%= t('selected') %>";
  const i18nSearchInput = "<%= t('search') %>";
  const i18nSave = "<%= t('save') %>";
  const i18nConfirm = "<%= t('confirm') %>";
  const i18nAreYouSure = "<%= t('are_you_sure') %>";
  const i18nSaving = "<%= t('saving') %>";
  const i18nUnexpectedResponse = "<%= t('unexpected_response') %>";
  const i18nErrorSaving = "<%= t('error_saving') %>";
  const i18nErrorGeneric = "<%= t('error_generic') %>";
  const i18nLoadFailed = "<%= t('load_failed') %>";

  function initMultiSelects(root) {
    const wraps = root.querySelectorAll('[data-multi-select]');
    wraps.forEach((wrap) => setupMultiSelect(wrap));
  }

  function setupMultiSelect(wrap) {
    if (wrap.dataset.multiReady === 'true') return;
    wrap.dataset.multiReady = 'true';

    const select = wrap.querySelector('select[multiple]');
    const tags = wrap.querySelector('[data-multi-tags]');
    const trigger = wrap.querySelector('[data-multi-trigger]');
    const menu = wrap.querySelector('[data-multi-menu]');
    const placeholder = wrap.querySelector('[data-multi-placeholder]');
    if (!select || !tags || !trigger || !menu || !placeholder) return;

    const closeMenu = () => menu.classList.add('hidden');
    const toggleMenu = () => menu.classList.toggle('hidden');

    const updateTags = () => {
      const selected = Array.from(select.options).filter((opt) => opt.selected);
      tags.innerHTML = '';
      if (!selected.length) {
        placeholder.textContent = i18nSelect;
        return;
      }
      placeholder.textContent = i18nSelected;
      selected.forEach((opt) => {
        const tag = document.createElement('span');
        tag.className = 'multi-tag';
        tag.textContent = opt.textContent.trim();
        const remove = document.createElement('button');
        remove.type = 'button';
        remove.innerHTML = '&times;';
        remove.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          opt.selected = false;
          select.dispatchEvent(new Event('change', { bubbles: true }));
        });
        tag.appendChild(remove);
        tags.appendChild(tag);
      });
    };

    const searchInput = document.createElement('input');
    searchInput.type = 'search';
    searchInput.autocomplete = 'off';
    searchInput.placeholder = i18nSearchInput;
    searchInput.className = 'mb-2 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-700 shadow-sm focus:border-slate-300 focus:outline-none focus:ring-2 focus:ring-accent/30';
    const optionsWrapper = document.createElement('div');
    optionsWrapper.className = 'space-y-1';
    menu.innerHTML = '';
    menu.appendChild(searchInput);
    menu.appendChild(optionsWrapper);

    const renderMenu = () => {
      const filter = (searchInput.value || '').trim().toLowerCase();
      optionsWrapper.innerHTML = '';
      Array.from(select.options).forEach((opt) => {
        const labelText = opt.textContent.trim();
        const matches = !filter || labelText.toLowerCase().includes(filter);
        if (filter && !matches && !opt.selected) return;
        const option = document.createElement('button');
        option.type = 'button';
        option.className = 'flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-sm text-slate-700 transition hover:bg-amber-50/60';
        const label = document.createElement('span');
        label.textContent = labelText;
        const check = document.createElement('span');
        check.className = 'text-xs text-slate-400';
        check.textContent = opt.selected ? '*' : '';
        option.appendChild(label);
        option.appendChild(check);
        option.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          opt.selected = !opt.selected;
          select.dispatchEvent(new Event('change', { bubbles: true }));
          renderMenu();
          closeMenu();
        });
        optionsWrapper.appendChild(option);
      });
    };

    trigger.addEventListener('click', (event) => {
      event.preventDefault();
      toggleMenu();
    });

    document.addEventListener('click', (event) => {
      if (!wrap.contains(event.target)) closeMenu();
    });

    select.addEventListener('change', () => {
      updateTags();
      renderMenu();
    });

    updateTags();
    renderMenu();
  }

  function openModal(url) {
    const shell = document.getElementById('modal-shell');
    const backdrop = document.getElementById('modal-backdrop');
    const content = document.getElementById('modal-content');

    shell.classList.remove('hidden');
    shell.classList.add('flex');
    backdrop.classList.remove('hidden');
    content.innerHTML = '<div class="flex h-40 items-center justify-center"><svg class="h-6 w-6 animate-spin text-slate-300" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

    const cacheBust = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();

    fetch(cacheBust, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      cache: 'no-store'
    })
      .then(res => res.text())
      .then(html => {
        content.innerHTML = html;
        const form = content.querySelector('form');
        if (form) form.addEventListener('submit', handleFormSubmit);
        initMultiSelects(content);
      })
        .catch(err => content.innerHTML = `<div class="p-6 text-red-600 text-center">${i18nLoadFailed}</div>`);
  }

  function togglePassword(btn) {
    const wrapper = btn.closest('.relative');
    if (!wrapper) return;
    const input = wrapper.querySelector('[data-password-input]');
    if (!input) return;
    const isHidden = input.type === 'password';
    input.type = isHidden ? 'text' : 'password';
    btn.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
    const eye = btn.querySelector('[data-eye-icon]');
    const eyeOff = btn.querySelector('[data-eye-off-icon]');
    if (eye && eyeOff) {
      eye.classList.toggle('hidden', isHidden);
      eyeOff.classList.toggle('hidden', !isHidden);
    }
  }

  document.addEventListener('click', (event) => {
    const btn = event.target.closest('[data-toggle-password]');
    if (!btn) return;
    event.preventDefault();
    togglePassword(btn);
  });

  function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn ? btn.innerText : i18nSave;
    if (btn) { btn.disabled = true; btn.innerText = i18nSaving; }

    const formData = new URLSearchParams(new FormData(form));

    const csrfToken = form.querySelector('input[name="_csrf"]')?.value;

    fetch(form.action, {
      method: form.method,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json',
        ...(csrfToken ? { 'X-CSRF-Token': csrfToken } : {})
      },
      body: formData
    })
    .then(async r => {
      const contentType = r.headers.get('content-type') || '';
      let body;
      if (contentType.includes('application/json')) {
        body = await r.json();
      } else {
        const text = await r.text();
        body = { error: text || i18nUnexpectedResponse };
      }
      return { status: r.status, body };
    })
    .then(({ status, body }) => {
      if (status >= 400 || body.error) {
        alert(body.error || i18nErrorSaving);
        if (btn) { btn.disabled = false; btn.innerText = originalText; }
      } else if (body.redirect) {
        window.location.href = body.redirect;
      }
    })
    .catch(err => {
      console.error(err);
      alert(i18nErrorGeneric);
      if (btn) { btn.disabled = false; btn.innerText = originalText; }
    });
  }

  const confirmModal = document.querySelector('[data-confirm-modal]');
  const confirmForm = document.querySelector('[data-confirm-form]');
  const confirmTitle = document.querySelector('[data-confirm-title]');
  const confirmMessage = document.querySelector('[data-confirm-message]');
  const confirmClose = document.querySelectorAll('[data-confirm-close]');

  const openConfirm = (title, message, action) => {
    if (!confirmModal || !confirmForm) return;
    confirmTitle.textContent = title || i18nConfirm;
    confirmMessage.textContent = message || i18nAreYouSure;
    confirmForm.setAttribute('action', action || '');
    confirmModal.classList.remove('hidden');
    confirmModal.classList.add('flex');
  };

  const closeConfirm = () => {
    if (!confirmModal) return;
    confirmModal.classList.add('hidden');
    confirmModal.classList.remove('flex');
  };

  confirmClose.forEach((btn) => btn.addEventListener('click', closeConfirm));
  confirmModal?.addEventListener('click', (event) => {
    if (event.target === confirmModal) closeConfirm();
  });

  document.addEventListener('click', (event) => {
    const toggleBtn = event.target.closest('[data-toggle]');
    if (toggleBtn) {
      event.preventDefault();
      const action = toggleBtn.getAttribute('data-toggle-action');
      const label = toggleBtn.getAttribute('data-toggle-label') || i18nAreYouSure;
      if (action) openConfirm(i18nConfirm, label, action);
      return;
    }
    const deleteBtn = event.target.closest('[data-delete]');
    if (deleteBtn) {
      event.preventDefault();
      const action = deleteBtn.getAttribute('data-delete-action');
      const label = deleteBtn.getAttribute('data-delete-label') || "<%= t('permanent_delete') %>";
      if (action) openConfirm(i18nConfirm, label, action);
    }
  });
</script>
